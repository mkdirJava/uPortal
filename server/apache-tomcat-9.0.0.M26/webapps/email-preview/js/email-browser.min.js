var jasig=jasig||{};(function(F,G){var P;var A;var D=function(Y,V){if(!Y.options.allowRenderingEmailContent){return false}C(Y);var Z=F(V).attr("messageId");var b=L(Y,Z);var X=b.content.html?b.content.contentString:"<pre>"+b.content.contentString+"</pre>";Y.container.find(".message-content").html(X);Y.container.find(".email-message .subject").html(b.subject);Y.container.find(".email-message .from").html(b.sender);Y.container.find(".email-message .sentDate").html(b.sentDateString);Y.container.find(".email-message .toRecipients").html(b.toRecipients);Y.container.find(".email-message .ccRecipients").html(b.ccRecipients);Y.container.find(".email-message .bccRecipients").html(b.bccRecipients);if(Y.container.find(".email-message .bccRecipients").text()==""){Y.container.find(".email-message .bccInfo").hide()}else{Y.container.find(".email-message .bccInfo").show()}Y.container.find(".email-message .message-uid").val(b.messageId);if(Y.options.markMessagesAsRead||!b.unread){Y.locate("markMessageReadButton").hide();Y.locate("markMessageUnreadButton").show()}else{Y.locate("markMessageReadButton").show();Y.locate("markMessageUnreadButton").hide()}var U=Y.cache[P][A];var a=-1;for(var W in U){var S=U[W];if(S.messageId===Z){a=parseInt(W);if(S.unread&&Y.options.markMessagesAsRead){S.unread=false;var T=parseInt(Y.locate("unreadMessageCount").html());if(T&&T>0){Y.locate("unreadMessageCount").html(T-1)}Y.pager.refreshView()}break}}if(a!=-1){if(a>0){var R=U[a-1];F(".email-message .previous-msg").attr("messageId",R.messageId);F(".email-message .previous-msg").show()}else{F(".email-message .previous-msg").hide()}if(a<U.length-1){var Q=U[a+1];F(".email-message .next-msg").attr("messageId",Q.messageId);F(".email-message .next-msg").show()}else{F(".email-message .next-msg").hide()}}K(Y);return false};var I={};var J="false";var B=function(U,W,S,R,Q,V){F.ajax({url:U.options.accountSummaryUrl,async:false,data:{pageStart:W,numberOfMessages:S,forceRefresh:J,inboxFolder:V},type:"POST",dataType:"json",success:function(X){if(X.errorMessage!=null){N(U,900,X.errorMessage)}J="false";I=X},error:function(Y,Z,X){N(U,Y.status)}});var T=I.accountSummary?I.accountSummary.messages:[];U.cache[W]=U.cache[W]||[];U.cache[W][S]=T;P=W;A=S;return T};var H=function(Q){return function(V,T,S,R,U){return B(Q,V,T,S,R,U)}};var L=function(S,Q){var R;F.ajax({url:S.options.messageUrl,async:false,data:{messageId:Q},type:"POST",dataType:"json",success:function(T){if(T.errorMessage!=null){N(S,900,T.errorMessage)}R=T.message},error:function(U,V,T){N(S,U.status)}});return R};var E=function(Q){Q.locate("loadingMessage").hide();Q.locate("emailMessage").hide();Q.locate("errorMessage").hide();Q.locate("emailList").show()};var C=function(Q){Q.locate("emailList").hide();Q.locate("emailMessage").hide();Q.locate("errorMessage").hide();Q.locate("loadingMessage").show()};var K=function(Q){Q.locate("loadingMessage").hide();Q.locate("emailList").hide();Q.locate("errorMessage").hide();Q.locate("emailMessage").show()};var N=function(T,R,S){T.locate("loadingMessage").hide();T.locate("emailList").hide();T.locate("emailMessage").hide();if(R==200){R=504}var Q=T.options.jsErrorMessages[R]||T.options.jsErrorMessages["default"];if(S){Q+="<br/>"+S}T.locate("errorText").html(R+": "+Q);T.locate("errorMessage").show()};var O=function(Q,S){var R="";if(S.unread){R+=" unread"}if(!S.unread){R+=" portlet-section-alternate"}if(S.answered){R+=" answered"}if(S.deleted){R+=" deleted"}if(S.multipart){R+=" attached"}return R};var M=function(R,Q){that.locate("emailRow").each(function(S,T){if(T.find(options.selectors.selectMessage).attr("checked")){T.remove()}})};jasig.EmailBrowser=function(R,T){var U=G.initView("jasig.EmailBrowser",R,T);U.cache=[];C(U);var Q={batchSize:U.options.batchSize,pagerOptions:{columnDefs:[{key:"select",valuebinding:"*.select",components:function(Z,Y){return{markup:'<input type="checkbox" class="select-message" name="selectMessage" value="${*.messageId}"/>',decorators:[{attrs:{messageId:"${*.messageId}"}},{type:"addClass",classes:O(Y,Z)}]}}},{key:"flags",valuebinding:"*.answered",components:function(Z,Y){return{decorators:[{type:"addClass",classes:O(Y,Z)}]}}},{key:"attachments",valuebinding:"*.multipart",components:function(Z,Y){return{decorators:[{type:"addClass",classes:O(Y,Z)}]}}},{key:"subject",valuebinding:"*.subject",components:function(Z,Y){if(U.options.allowRenderingEmailContent){return{markup:'<a href="javascript:;">${*.subject}</a>',decorators:[{attrs:{messageId:"${*.messageId}"}},{type:"jQuery",func:"click",args:function(){D(U,this)}},{type:"addClass",classes:O(Y,Z)}]}}return{markup:"<span>${*.subject}</span>",decorators:[{attrs:{messageId:"${*.messageId}"}},{type:"addClass",classes:O(Y,Z)}]}}},{key:"sender",valuebinding:"*.senderName",components:function(Z,Y){return{value:"${*.senderName}",decorators:[{type:"addClass",classes:O(Y,Z)}]}}},{key:"sentDate",valuebinding:"*.sentDateString",components:function(Z,Y){return{value:"${*.sentDateString}",decorators:[{type:"addClass",classes:O(Y,Z)}]}}}],bodyRenderer:{type:"fluid.pager.selfRender",options:{selectors:{root:U.options.messagesInfoContainer},row:"row:"}},pagerBar:{type:"fluid.pager.pagerBar",options:{pageList:{type:"fluid.pager.renderedPageList",options:{linkBody:"a",pageStrategy:G.pager.gappedPageStrategy(3,1)}}}},model:{pageSize:U.options.pageSize},listeners:U.options.listeners},dataFunction:H(U,U.options.folderName),dataLengthFunction:function(){return I.accountSummary?I.accountSummary.totalMessageCount:0}};U.pager=unicon.batchedpager(U.locate("emailList"),Q);if(I.accountSummary){U.refresh=function(){C(U);J="true";U.cache=[];U.pager.refreshView();U.locate("unreadMessageCount").html(I.accountSummary.unreadMessageCount);E(U)};var W=function(Z){C(U);var Y={url:T.deleteUrl,type:"POST",data:Z,dataType:"json",error:function(a,c,b){N(U,a.status)},success:function(a){if(a.errorMessage!=null){N(U,900,a.errorMessage)}U.refresh()}};F.ajax(Y)};var V=function(Z,a){C(U);Z.push({name:"seenValue",value:a});var Y={url:T.toggleSeenUrl,type:"POST",data:Z,dataType:"json",error:function(b,d,c){N(U,b.status)},success:function(b){if(b.errorMessage!=null){N(U,900,b.errorMessage)}U.refresh()}};F.ajax(Y)};var X=function(){C(U);var Y={url:T.inboxFolderUrl,type:"POST",data:{},dataType:"json",success:function(a){var Z=U.locate("allFolders");F("option",Z).remove();if(Z.prop){var b=Z.prop("options")}else{var b=Z.attr("options")}var c;F.each(a,function(e,d){if(e=="selected"){c=d}else{b[b.length]=new Option(e,d)}});Z.html(Z.children("option").sort(function(e,d){return e.text==d.text?0:e.text<d.text?-1:1}));Z.val(c);F(".styled-select .ui-btn-text").html(c);Z.find("option[value='INBOX']").css("color","red").css("font-weight","bold");Z.find("option[value='inbox']").css("color","red").css("font-weight","bold");F("option:contains(':unread')").css("font-weight","bold");F("option:contains(':unread')").html(function(d,e){return e.replace(/:unread/g,"")});console.log("list completed")}};F.ajax(Y)};U.deleteSelectedMessages=function(){if(U.locate("emailRow").find("input:checked").size()===0){alert(U.options.jsMessages.noMessagesSelected);return }if(confirm(U.options.jsMessages.deleteSelectedMessages)){W(U.locate("inboxForm").serializeArray())}};U.deleteShownMessage=function(){if(confirm(U.options.jsMessages.deleteMessage)){W(U.locate("messageForm").serializeArray())}};U.toggleSelectAll=function(){var Y=F(this).attr("checked");U.locate("selectMessage").attr("checked",Y)};U.locate("refreshLink").click(U.refresh);if(I.accountSummary.deleteSupported){U.locate("deleteMessagesLink").click(U.deleteSelectedMessages);U.locate("deleteMessageButton").click(U.deleteShownMessage);U.locate("deleteMessageButton").show()}else{var S=U.locate("deleteMessagesLink");S.find("span").html(U.options.jsMessages.deleteNotAvailable);S.find("span").addClass("fl-text-silver");S.attr("title",U.options.jsMessages.deleteNotAvailableTitle);U.locate("deleteMessageButton").hide()}U.locate("returnLink").click(function(){E(U)});U.locate("previousMsg").click(function(){D(U,this)});U.locate("nextMsg").click(function(){D(U,this)});U.locate("markMessageReadButton").click(function(){V(U.locate("messageForm").serializeArray(),"true")});U.locate("markMessageUnreadButton").click(function(){V(U.locate("messageForm").serializeArray(),"false")});U.locate("allFolders").ready(function(){X()});U.locate("allFolders").change(function(){J="true";B(U,0,U.options.batchSize,undefined,undefined,U.locate("allFolders").val());location.reload()});U.locate("inboxLink").attr("href",I.inboxUrl);U.locate("mobileSelect").find("span.ui-btn-text").html(U.options.pageSize);U.locate("selectAll").live("click",U.toggleSelectAll);U.locate("unreadMessageCount").html(I.accountSummary.unreadMessageCount);if(I.spaceUsed=="-1"){U.locate("stats").remove()}if(I.emailQuotaUsage<=0||I.emailQuotaLimit<=0){U.locate("stats").remove()}else{U.locate("emailQuotaUsage").html(I.emailQuotaUsage);U.locate("emailQuotaLimit").html(I.emailQuotaLimit)}E(U)}return U};G.defaults("jasig.EmailBrowser",{accountSummaryUrl:null,messageUrl:null,deleteUrl:null,toggleSeenUrl:null,inboxFolderUrl:null,pageSize:10,batchSize:20,selectors:{refreshLink:".refresh-link",deleteMessagesLink:".delete-link",returnLink:".return-link",inboxForm:"form[name='inboxForm']",messageForm:"form[name='messageForm']",allFolders:"#allFolders",deleteMessageButton:".delete-message-button",markMessageReadButton:".mark-read-button",markMessageUnreadButton:".mark-unread-button",timestamp:"input[name='timestamp']",selectAll:".select-all",selectMessage:".select-message",emailList:".email-list",emailRow:".email-row",emailMessage:".email-message",loadingMessage:".loading-message",errorMessage:".error-message",errorText:".error-message #error-text",unreadMessageCount:".unread-message-count",inboxLink:".inbox-link",emailQuotaUsage:".email-quota-usage",emailQuotaLimit:".email-quota-limit",stats:".stats",bccRecipients:".bcc-recipients",ccRecipients:".cc-recipients",toRecipients:".to-recipients",previousMsg:".previous-msg",nextMsg:".next-msg",mobileSelect:"#mobileSelect"},listeners:{},jsErrorMessages:{"default":"Server Error"},markMessagesAsRead:true})
})(jQuery,fluid);